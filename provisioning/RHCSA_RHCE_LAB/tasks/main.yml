---
# epel-release needs to be installed before installing bash-completion, haveged etc.
- name: enable Extra Packages for Enterprise Linux (epel)
  yum:
    name: epel-release
    state: present

- name: Install Bash Completion (for nmcli)
  yum: name={{ item }} state=present
  with_items:
    - libselinux-python
    - python-pip # for tzupdate
    - bash-completion
  notify: update pip

- name: pip install tzupdate
  pip:
    name: tzupdate

# see https://github.com/cdown/tzupdate TODO CentOS GUI can be set to detect timezone, but how can we set this automated?
- name: set timezone based on geolocation
  shell: /bin/sleep 15; tzupdate # sleep prevents Python error when running tzupdate immediate after install
  async: 60 # takes quite some time
  poll: 0 # we don't need to wait for this to finish

# TODO labipa boots with GUI, install GUI on Server1 but boot in multi-user.target and on Server2 do not install GUI.
- name: "Install 'Server With GUI' environment group"
  yum:
    name="@^Server With GUI"
    state="present"
  when: gui == true
  notify: runlevel 5

- name: "Add user account & set its password"
  user:
    name="{{ default_user_name }}"
    groups="wheel"
    password="{{ default_user_password }}"
    update_password="always"

- name: "change root password"
  user:
    name="root"
    password="{{ root_user_password }}"
    update_password="always"

- name: "Add PEERDNS=no option"
  lineinfile:
    dest="/etc/sysconfig/network-scripts/ifcfg-eth0"
    line="PEERDNS=no"
  notify: restart network

- name: Check exists /etc/sysconfig/network-scripts/ifcfg-eth1
  stat:
    path: /etc/sysconfig/network-scripts/ifcfg-eth1
  register: ifcfg_eth1_state

- name: modify private connection
  shell: nmcli connection modify Wired\ connection\ 1 connection.id eth1 ipv4.addresses {{ private_ip_address }}/24 ipv4.dns {{ primary_dns }} ipv4.method manual ipv6.method ignore
  notify: restart network
  when: ifcfg_eth1_state.stat.exists == false

- name: name private connection 'System eth1'
  shell: nmcli connection modify eth1 connection.id System\ eth1
  notify: restart network
  when: ifcfg_eth1_state.stat.exists == false

# sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
- name: allow ssh logon with password
  replace:
    dest: /etc/ssh/sshd_config
    regexp: ^PasswordAuthentication no
    replace: PasswordAuthentication yes
  notify: restart sshd

 # support 'scp labipa.example.com:/etc/ipa/ca.crt /etc/openldap/cacerts/' p145
- name: make /etc/openldap/cacerts directory
  file:
    path: /etc/openldap/cacerts
    state: directory
